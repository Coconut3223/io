<!DOCTYPE html>

<html lang="zh-CN" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>SQL &#8212; HomePage</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css?v=79c92029" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../_static/css/def.css?v=5a9d86bd" />
    <script src="../_static/documentation_options.js?v=7d86a446"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=6dbb43f8"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="杂" href="../utils/index.html" />
    <link rel="prev" title="SQL" href="index.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#SQL/main" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="HomePage"
           class="md-header-nav__button md-logo">
          
            <i class="md-icon">&#xe869</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Cocobook</span>
          <span class="md-header-nav__topic"> SQL </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/Coconut3223/io/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    io
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">HomePage</a></li>
            
            <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Homepage</a></li>
            
            <li class="md-tabs__item"><a href="../AI/index.html" class="md-tabs__link">AI</a></li>
            
            <li class="md-tabs__item"><a href="../python/index.html" class="md-tabs__link">Python</a></li>
            
            <li class="md-tabs__item"><a href="../NLP/index.html" class="md-tabs__link">NLP</a></li>
            
            <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">SQL</a></li>
            
            <li class="md-tabs__item"><a href="../utils/index.html" class="md-tabs__link">Utils</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">SQL</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="HomePage" class="md-nav__button md-logo">
      
        <i class="md-icon">&#xe869</i>
      
    </a>
    <a href="../index.html"
       title="HomePage">Cocobook</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/Coconut3223/io/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    io
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Content</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../AI/index.html" class="md-nav__link">AI</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../AI/ML/index.html" class="md-nav__link">ML</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../AI/DL/index.html" class="md-nav__link">DL</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../CV/index.html" class="md-nav__link">CV</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../NLP/index.html" class="md-nav__link">NLP</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../python/index.html" class="md-nav__link">python</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">SQL</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../utils/index.html" class="md-nav__link">utils</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#sql-main--page-root" class="md-nav__link">SQL</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#datatype" class="md-nav__link">datatype</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#div-id-unicode-div" class="md-nav__link"><div id =’unicode’ > 编码</div></a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#charset" class="md-nav__link">charset</a>
        </li>
        <li class="md-nav__item"><a href="#collate" class="md-nav__link">collate</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#int" class="md-nav__link">int</a>
        </li>
        <li class="md-nav__item"><a href="#char" class="md-nav__link">char</a>
        </li>
        <li class="md-nav__item"><a href="#format" class="md-nav__link">format</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#query" class="md-nav__link">query</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id1" class="md-nav__link">一些特别的选取</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id2" class="md-nav__link">日期</a>
        </li>
        <li class="md-nav__item"><a href="#id3" class="md-nav__link">数字</a>
        </li>
        <li class="md-nav__item"><a href="#id4" class="md-nav__link">字符串字段</a>
        </li>
        <li class="md-nav__item"><a href="#long-string" class="md-nav__link">长字符串 long string</a>
        </li>
        <li class="md-nav__item"><a href="#id5" class="md-nav__link">模糊查询</a>
        </li>
        <li class="md-nav__item"><a href="#id6" class="md-nav__link">复合条件的查询</a>
        </li>
        <li class="md-nav__item"><a href="#with-group-by" class="md-nav__link">统计- 聚合函数 with  <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code></a>
        </li>
        <li class="md-nav__item"><a href="#id7" class="md-nav__link">连表查询</a>
        </li>
        <li class="md-nav__item"><a href="#id8" class="md-nav__link">拼接</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id9" class="md-nav__link">分组</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id10" class="md-nav__link">窗口函数</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#id11" class="md-nav__link">常见业务</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#operations" class="md-nav__link">operations</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#insert" class="md-nav__link">insert</a>
        </li>
        <li class="md-nav__item"><a href="#alter-update" class="md-nav__link">alter & update</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#alter-scheme" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">alter</span></code>  基于表 scheme</a>
        </li>
        <li class="md-nav__item"><a href="#update-records" class="md-nav__link"><code class="docutils literal notranslate"><span class="pre">update</span></code>   基于记录 records</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#delete-truncate" class="md-nav__link">delete & truncate</a>
        </li>
        <li class="md-nav__item"><a href="#create" class="md-nav__link">create</a>
        </li>
        <li class="md-nav__item"><a href="#index" class="md-nav__link">index</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#create2" class="md-nav__link">create2</a>
        </li>
        <li class="md-nav__item"><a href="#delete" class="md-nav__link">delete</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id12" class="md-nav__link">业务</a>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="sql">
<h1 id="sql-main--page-root">SQL<a class="headerlink" href="#sql-main--page-root" title="Link to this heading">¶</a></h1>
<p>mysql 底层的索引是B+ tree</p>
<div class="admonition- admonition danger">
<p class="admonition-title">集合操作提高连表效率</p>
<p>查找男女重名的名字</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="k">from</span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">student</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'male'</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">distince</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">student</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'female'</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">s1</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">name</span>
<span class="k">having</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
</pre></div>
</div>
</div>
<section id="datatype">
<h2 id="datatype">datatype<a class="headerlink" href="#datatype" title="Link to this heading">¶</a></h2>
<section id="div-id-unicode-div">
<h3 id="div-id-unicode-div">&lt;div id =’unicode’ &gt; 编码&lt;/div&gt;<a class="headerlink" href="#div-id-unicode-div" title="Link to this heading">¶</a></h3>
<section id="charset">
<h4 id="charset">charset<a class="headerlink" href="#charset" title="Link to this heading">¶</a></h4>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>charset</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">utf8</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">utf8_general_ci</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">utf8mb4</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">utf8mb4_unicode_ci</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="collate">
<h4 id="collate">collate<a class="headerlink" href="#collate" title="Link to this heading">¶</a></h4>
<p>实际上符号都是编码储存的，编码会影响读取的速度、排序的位置、是否区分大小写、支持的符号等等问题。</p>
<table>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>example</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>general</cite></p></td>
<td><p><cite>utf8mb4_general_ci</cite></p></td>
<td><p>在排序時比較快，但在某些特殊情況會排錯</p></td>
</tr>
<tr class="row-odd"><td><p><cite>unicode</cite> 👍</p></td>
<td><p><cite>utf8mb4_unicode_ci</cite></p></td>
<td><p>完整的 Unicode 標準，會存中文、德文、Emoji</p></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>大小写区分</p></th>
<th class="head"></th>
<th class="head"><p>大小寫</p></th>
<th class="head"><p>特殊符号</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>ci</cite> <strong>default</strong></p></td>
<td><p>case-insensitive</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-odd"><td><p><cite>bin</cite></p></td>
<td><p>binary value</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-even"><td><p><cite>cs</cite></p></td>
<td><p>case-sensitive</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>[MySQL 編碼挑選與差異比較]</p></li>
</ul>
</section>
</section>
<section id="int">
<h3 id="int">int<a class="headerlink" href="#int" title="Link to this heading">¶</a></h3>
<div class="admonition-int-m admonition note">
<p class="admonition-title">int(M)</p>
<p><code class="docutils literal notranslate"><span class="pre">int(M:max_display_width)</span></code>  ,无论 M 是多少，都是 int 类型，也就是存储  <code class="docutils literal notranslate"><span class="pre">bytes</span> <span class="pre">=</span> <span class="pre">4</span></code></p>
<ul class="simple">
<li><p>[int(1)和int(11)的区别]</p></li>
</ul>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>datatype</p></th>
<th class="head"><p>bytes</p></th>
<th class="head"><p>default_M</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>tinyint</p></td>
<td><p>1</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>smallint</p></td>
<td><p>2</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>mediumint</p></td>
<td><p>3</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><strong>int</strong></p></td>
<td><p>4</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>bigint</p></td>
<td><p>8</p></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="char">
<h3 id="char">char<a class="headerlink" href="#char" title="Link to this heading">¶</a></h3>
<div class="admonition-mysql-varchar-char admonition note">
<p class="admonition-title">“根据 Mysql 官方建议，使用 VARCHAR 替代 CHAR”</p>
</div>
</section>
<section id="format">
<h3 id="format">format<a class="headerlink" href="#format" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>四舍五入，保留n位小数  <code class="docutils literal notranslate"><span class="pre">round(col,</span> <span class="pre">n)</span></code></p></li>
<li><p>大小写  <code class="docutils literal notranslate"><span class="pre">lower(col)</span></code> ,  <code class="docutils literal notranslate"><span class="pre">upper(col)</span></code></p></li>
</ul>
</section>
</section>
<section id="query">
<h2 id="query">query<a class="headerlink" href="#query" title="Link to this heading">¶</a></h2>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span> <span class="pre">from</span> <span class="pre">users;</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">&lt;old_col_name&gt;</span> <span class="pre">as</span> <span class="pre">&lt;new_col_name&gt;</span> <span class="pre">from</span> <span class="pre">users;</span></code></div>
</div>
<div class="admonition-select-select-col1-col2 admonition note">
<p class="admonition-title">尽量不要使用  <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span></code> , 而是显式列列表  <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">col1,</span> <span class="pre">col2,...</span></code></p>
<p>在项目中  <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span></code>  会影响到整个项目的性能，会给服务器造成一定的压力。</p>
</div>
<div class="admonition-select-1-from-table admonition note">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">1</span> <span class="pre">from</span> <span class="pre">table;</span></code>  的用法</p>
<div class="line-block">
<div class="line">当我们只关心数据表有多少记录行而不需要知道具体的字段值。</div>
<div class="line">通常用于子查询。</div>
</div>
<ul>
<li><dl class="simple">
<dt>结果</dt><dd><p>对符合条件的记录返回的永远只有一个值  <code class="docutils literal notranslate"><span class="pre">1</span></code> ，当然，如果有返回值的话。 查询到有多少记录行存在就输出多少个“1”，每个“1”代表有1行记录</p>
</dd>
</dl>
</li>
<li><p>优点</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">1</span> <span class="pre">...</span></code>  &gt;  <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">constant</span>  <span class="pre">...</span></code>  &gt;  <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">col</span> <span class="pre">...</span></code>  &gt;   <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span> <span class="pre">...</span></code></p></li>
<li><p>此时数据库就不会去检索数据表里每条具体的记录和每条记录里每个具体的字段值并将它们放到内存里，可以 <strong>减少系统开销，提高运行效率</strong></p></li>
<li><p>选用数字 <code class="docutils literal notranslate"><span class="pre">1</span></code> 是因为它所占用的内存空间最小，而且具有统计用途</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">查看存不存在</span>
<span class="err">$</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">usrs</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">[</span><span class="n">conditions</span><span class="p">]</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">1</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">快速统计有多少条</span>
<span class="err">$</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">[</span><span class="n">conditions</span><span class="p">]</span>

<span class="o">#</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="err">子查询</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
</div>
<img alt="../_images/select_1.PNG" src="../_images/select_1.PNG"/>
<ul class="simple">
<li><p>[SELECT 1 FROM TABLE的作用]</p></li>
<li><p>[select 1 in SQL]</p></li>
</ul>
<section id="id1">
<h3 id="id1">一些特别的选取<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<ul>
<li><dl>
<dt>条件</dt><dd><ul class="simple">
<li><p>为空  <code class="docutils literal notranslate"><span class="pre">null</span></code></p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
<section id="id2">
<h4 id="id2">日期<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h4>
<ul>
<li><dl>
<dt>格式</dt><dd><ul>
<li><dl>
<dt>常见的日期数据格式 <code class="docutils literal notranslate"><span class="pre">'yyyy-mm-dd</span> <span class="pre">h:m:s'</span></code>  和  <code class="docutils literal notranslate"><span class="pre">'yyyymmdd'</span></code></dt><dd><div class="admonition- admonition danger">
<p class="admonition-title">要加引号</p>
</div>
</dd>
</dl>
</li>
<li><p>转换</p></li>
<li><p>轉換格式  <code class="docutils literal notranslate"><span class="pre">date_format(date,</span> <span class="pre">format)</span></code></p>
<blockquote>
<div><table>
<thead>
<tr class="row-odd"><th class="head"><p>format</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%Y</span></code></p></td>
<td><p>4位，2022</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%y</span></code></p></td>
<td><p>2位，22</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%M</span></code></p></td>
<td><p>月名，June</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%m</span></code></p></td>
<td><p>月（00-12），06</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%d</span></code></p></td>
<td><p>天（00-31），06</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%e</span></code></p></td>
<td><p>天（0-31），6</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p>时间戳</p>
<blockquote>
<div><div class="admonition- admonition note">
<p class="admonition-title">“时间戳和日期格式之间”</p>
<p>在实际工作环境中，对于用户行为发生的时间通常都是用**时间戳**进行记录，时间戳和日期格式之间可以利用 <code class="docutils literal notranslate"><span class="pre">from_unixtime</span></code>  和  <code class="docutils literal notranslate"><span class="pre">unix_timestamp</span></code>  进行转换。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">时间戳</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">日期</span>
<span class="k">select</span><span class="w"> </span><span class="n">from_unixtime</span><span class="p">(</span><span class="k">timestamp</span><span class="p">,</span><span class="s1">'yyyy-MM-dd'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span>
<span class="k">From</span><span class="w"> </span><span class="n">question_practice_detail</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">日期</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="err">时间戳</span>
<span class="k">select</span><span class="w"> </span><span class="n">unix_timestamp</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="s1">'yyyy-MM-dd'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">timestamp</span>
<span class="k">From</span><span class="w"> </span><span class="n">question_practice_detail</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</li>
<li><p>拿到信息，based on 常见时间格式</p>
<blockquote>
<div><table>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"><p>examples</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">year(date),</span> <span class="pre">month(date),</span> <span class="pre">day(date)</span></code></p></td>
<td><p>提取年月日</p></td>
<td><p>return int</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">last_day(date)</span></code></p></td>
<td><p>這年這月的最後一天的date</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">last_day('20170221')</span></code> -&gt; 2017-02-28</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p>日期差計算</p>
<blockquote>
<div><table>
<thead>
<tr class="row-odd"><th class="head"><p>case</p></th>
<th class="head"><p>计算时间间隔： <strong>在这之前，在这之后</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>天数</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">datediff(date_1,</span> <span class="pre">date_2)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>自定义</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">timestampdiff(unit,date_1,date_2)</span></code> , unit: <code class="docutils literal notranslate"><span class="pre">day,month,miniute</span></code></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>如果 date_1 or date_2 is null , return null</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">date_sub(start_date,</span> <span class="pre">interval</span> <span class="pre">n</span> <span class="pre">day)</span></code>  返回start_date <strong>减少</strong> n 天后的日期。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">date_add(start_date,</span> <span class="pre">interval</span> <span class="pre">n</span> <span class="pre">day)</span></code>  返回 start_date <strong>增加</strong> n 天后的日期</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">返回来的单位是天数</span>
<span class="k">select</span><span class="w"> </span><span class="n">datediff</span><span class="p">(</span><span class="s1">'2021-08–01'</span><span class="p">,</span><span class="w"> </span><span class="s1">'2021-08–05'</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">;</span>
<span class="k">select</span><span class="w"> </span><span class="n">timestampdiff</span><span class="p">(</span><span class="k">minute</span><span class="p">,</span><span class="s1">'2021-08–01'</span><span class="p">,</span><span class="w"> </span><span class="s1">'2021-08–05'</span><span class="p">)</span><span class="w"> </span><span class="p">...;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span>
<span class="k">select</span><span class="w"> </span><span class="n">date_sub</span><span class="p">(</span><span class="s1">'2021-08–01'</span><span class="p">,</span><span class="nb">interval</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="k">day</span><span class="p">)</span><span class="w"> </span><span class="p">...;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span>
<span class="k">select</span><span class="w"> </span><span class="n">date_add</span><span class="p">(</span><span class="s1">'2021-08–01'</span><span class="p">,</span><span class="nb">interval</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="k">day</span><span class="p">)</span><span class="w"> </span><span class="p">...;</span>
</pre></div>
</div>
<div class="admonition-exam-record202191-2099-01-01-00-00-00-0 admonition hint">
<p class="admonition-title">请把exam_record表中2021年9月1日之前开始作答的未完成记录全部改为被动完成，即：将完成时间改为’2099-01-01 00:00:00’，分数改为0</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span><span class="w"> </span><span class="n">exam_record</span>
<span class="k">set</span><span class="w"> </span><span class="n">submit_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'2099-01-01 00:00:00'</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">where</span><span class="w"> </span><span class="n">datediff</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="s1">'2021-09-01'</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">and</span>
<span class="n">submit_time</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition-exam-record5-60 admonition hint">
<p class="admonition-title">请删除exam_record表中作答时间小于5分钟整且分数不及格（及格线为60分）的记录；</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="k">where</span><span class="w"> </span><span class="n">timestampdiff</span><span class="p">(</span><span class="k">minute</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">submit_time</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
</pre></div>
</div>
</div>
<ul>
<li><p>[日期函数]</p>
<blockquote>
<div><div class="admonition- admonition hint">
<p class="admonition-title">现在运营想要计算出2021年8月每天用户练习题目的数量</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="k">day</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">day</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">question_cnt</span>
<span class="k">from</span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="nb">date</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">question_practice_detail</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="k">year</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="o">=</span><span class="mi">2021</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">month</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="o">=</span><span class="mi">8</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">new</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">day</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
</ul>
</section>
<section id="id3">
<h4 id="id3">数字<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">区间内</span><span class="w"> </span><span class="p">[</span><span class="n">m</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">]</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span>

<span class="o">#</span><span class="w"> </span><span class="err">在用</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="err">的时候要先去看看数据库的这个语法的规定</span>
<span class="o">#</span><span class="w"> </span><span class="err">在</span><span class="w"> </span><span class="n">mysql</span><span class="w"> </span><span class="err">里是</span><span class="n">__双闭区间__</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="id4">
<h4 id="id4">字符串字段<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">等于</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">区间</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">'val1'</span><span class="p">,</span><span class="w"> </span><span class="s1">'val2'</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
</pre></div>
</div>
</section>
<section id="long-string">
<h4 id="long-string">长字符串 long string<a class="headerlink" href="#long-string" title="Link to this heading">¶</a></h4>
<p>需要进行再一步提取处理</p>
<ul>
<li><p>找位置， return 位置索引</p>
<blockquote>
<div><p>返回子串  <code class="docutils literal notranslate"><span class="pre">substr</span></code>  在字符串  <code class="docutils literal notranslate"><span class="pre">str</span></code>  中第一次出现的位置，if not exist: 0；</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">locate(substr,</span> <span class="pre">str)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">find_in_set(substr,str)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">str</span></code> <strong>必须以”,”分割开</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">instr(str,</span> <span class="pre">substr)</span></code></p></li>
</ul>
<div class="admonition- admonition danger">
<p class="admonition-title">参数位置</p>
<div class="line-block">
<div class="line">locate、position 和 instr 的差別只是参数的位置不同，</div>
<div class="line">同时locate 多一个请始位置的参数外,可以自定义选择的起始位置</div>
</div>
</div>
</div></blockquote>
</li>
<li><p>替代 like</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">替代</span><span class="w"> </span><span class="k">like</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">locate</span><span class="p">(</span><span class="n">substr</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="c1">----------------------------</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="k">position</span><span class="p">(</span><span class="n">substr</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">str</span><span class="p">);</span>
<span class="c1">------------------------------</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">instr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">substr</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="c1">-------------------------------</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">find_in_set</span><span class="p">(</span><span class="n">substr</span><span class="p">,</span><span class="n">str</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition-locate-position-instr-like admonition note">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">locate,</span> <span class="pre">position,</span> <span class="pre">instr,</span> <span class="pre">like</span></code></p>
<p>速度上这三个比用 like 稍快了一點。</p>
</div>
</div></blockquote>
</li>
<li><dl>
<dt>截取</dt><dd><ul>
<li><dl class="simple">
<dt>单纯根据 位置索引</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">left(str,</span> <span class="pre">n)</span></code> ,  <code class="docutils literal notranslate"><span class="pre">right(str,</span> <span class="pre">n)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">substring(str,</span> <span class="pre">n,</span> <span class="pre">m)</span></code> ：str[n:n+m] 第 n 个开始，m 个</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>根据  <code class="docutils literal notranslate"><span class="pre">substr</span></code></dt><dd><ul>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">substring_index(str,</span> <span class="pre">substr,</span> <span class="pre">n)</span></code> ：   <code class="docutils literal notranslate"><span class="pre">substr</span></code>  在  <code class="docutils literal notranslate"><span class="pre">str</span></code>  中**第 n 次出现之前的字符串**;</dt><dd><div class="math">
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathsize="0.9em"><mrow><mi>n</mi><mrow><mo fence="true">{</mo><mtable columnalign="left left" columnspacing="1em" rowspacing="0.36em"><mtr><mtd><mstyle displaystyle="false" scriptlevel="0"><mrow><mo>&gt;</mo><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle displaystyle="false" scriptlevel="0"><mtext>从左往右数，第n个的左边的所有内容</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle displaystyle="false" scriptlevel="0"><mrow><mo>&lt;</mo><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle displaystyle="false" scriptlevel="0"><mtext>从右往左数，第n个的右边的所有内容</mtext></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mrow><annotation encoding="application/x-tex">\small{n\begin{cases}&gt;0&amp;\text{从左往右数，第n个的左边的所有内容}\\&lt;0&amp;\text{从右往左数，第n个的右边的所有内容}\end{cases}}

</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:2.592em;vertical-align:-1.071em;"></span><span class="mord sizing reset-size6 size5"><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen sizing reset-size5 size6 delimcenter" style="top:0.025em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">从左往右数，第</span><span class="mord">n</span><span class="mord cjk_fallback">个的左边的所有内容</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">从右往左数，第</span><span class="mord">n</span><span class="mord cjk_fallback">个的右边的所有内容</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size5 size6"></span></span></span></span></span></span></span></div></dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>替换</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">replace(str,</span> <span class="pre">substr_a,</span> <span class="pre">substr_b)</span></code> ： <code class="docutils literal notranslate"><span class="pre">str</span></code>  中的  <code class="docutils literal notranslate"><span class="pre">substr_a</span></code>  替换成  <code class="docutils literal notranslate"><span class="pre">substr_b</span></code> ；</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>信息</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">length(str)</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>[MySQL常用函数——字符函数]</p></li>
</ul>
<div class="admonition- admonition hint">
<p class="admonition-title">现在运营举办了一场比赛，收到了一些参赛申请，表数据记录形式如下所示，</p>
<ol class="arabic simple">
<li><p>现在运营想要统计每个性别的用户分别有多少参赛者</p></li>
<li><p>现在运营想要统计每个年龄的用户分别有多少参赛者，请取出相应结果</p></li>
</ol>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>user_submit</p></th>
<th class="head"></th>
<th class="head"></th>
<th class="head"><p>result</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dvice_id</p></td>
<td><p>profile</p></td>
<td><p>gender</p></td>
<td><p>number</p></td>
</tr>
<tr class="row-odd"><td><p>2138</p></td>
<td><p>180cm,75kg,27,male</p></td>
<td><p>male</p></td>
<td><p>2</p></td>
</tr>
</tbody>
</table>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">每个性别</span>
<span class="k">select</span><span class="w"> </span><span class="n">substring_index</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span><span class="w"> </span><span class="s1">','</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">number</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_submit</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">gender</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">每个年龄</span>
<span class="k">select</span><span class="w"> </span><span class="n">substring_index</span><span class="p">(</span><span class="n">substring_index</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span><span class="s1">','</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="s1">','</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">age</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">number</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_submit</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">age</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition-sql-id-cust-id-cust-name-user-login-cust-contact-cust-city admonition hint">
<p class="admonition-title">编写 SQL 语句，返回顾客 ID（cust_id）、顾客名称（cust_name）和登录名（user_login），其中登录名全部为大写字母，并由顾客联系人的前两个字符（cust_contact）和其所在城市的前三个字符（cust_city）组成。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">cust_id</span><span class="p">,</span><span class="w"> </span><span class="n">cust_name</span><span class="p">,</span>
<span class="w">    </span><span class="k">upper</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="k">left</span><span class="p">(</span><span class="n">cust_name</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="k">left</span><span class="p">(</span><span class="n">cust_city</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_login</span>
<span class="k">from</span><span class="w"> </span><span class="n">Customers</span><span class="p">;</span>
</pre></div>
</div>
</div>
</section>
<section id="id5">
<h4 id="id5">模糊查询<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h4>
<div class="admonition- admonition danger">
<p class="admonition-title">“尽量避免通配符在开头”</p>
<div class="line-block">
<div class="line">当  <code class="docutils literal notranslate"><span class="pre">like</span></code>  模式以通配符（例如“%xyz”）开头时，MySQL不能使用索引，并在这种情况下执行完整表扫描。</div>
<div class="line">通常会导致服务器性能下降。</div>
</div>
<ul>
<li><p>后缀搜索</p>
<blockquote>
<div><div class="admonition- admonition note">
<p class="admonition-title">对后缀搜索的优化：</p>
<p>可以通过创建新列、将其值设置为与目标列逆序的值并对其建立索引来执行高效的后缀搜索。从后缀转为前缀</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">name</span>
<span class="k">from</span><span class="w"> </span><span class="k">table</span>
<span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">'%ic'</span><span class="p">;</span>
<span class="o">#</span><span class="w"> </span><span class="c1">---------------------- 后缀转前缀</span>
<span class="k">where</span><span class="w"> </span><span class="n">name_reversed</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">'ic%'</span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><p>中缀搜索</p>
<blockquote>
<div><div class="admonition-fulltext-index admonition danger">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">fulltext</span> <span class="pre">index</span></code></p>
<p>没有有效的方法来执行 <strong>中缀搜索</strong>，无论是LIKE在索引列上还是使用全文索引。</p>
</div>
</div></blockquote>
</li>
</ul>
</div>
<ol class="arabic">
<li><p>sql 自带 模式匹配  <code class="docutils literal notranslate"><span class="pre">like</span></code>  + 通配符  <code class="docutils literal notranslate"><span class="pre">%_</span></code></p>
<blockquote>
<div><table>
<thead>
<tr class="row-odd"><th class="head"><p>通配符</p></th>
<th class="head"><p>含义</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%</span></code></p></td>
<td><p>任意多个，包括0</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">_</span></code></p></td>
<td><p>单个，有长度限制</p></td>
</tr>
</tbody>
</table>
<ul>
<li><p>精确匹配。如果不跟通配符合用就等于  <code class="docutils literal notranslate"><span class="pre">=</span></code> ：精确等于。不能返回包含关系的行</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="err">精确匹配</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">'yes'</span>
<span class="c1">---------------------- # 只有'yes'能被匹配到</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><strong>注意大小写</strong>， 因为sql自带的，所以是否区分大小写看用户对MySQL的配置方式</p></li>
<li><p><strong>不能匹配到</strong> <code class="docutils literal notranslate"><span class="pre">null</span></code></p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">以</span><span class="w"> </span><span class="err">‘</span><span class="n">yes</span><span class="err">‘</span><span class="w"> </span><span class="err">开头</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">'yes%'</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">以</span><span class="w"> </span><span class="err">‘</span><span class="n">yes</span><span class="err">’开头，长度为</span><span class="mi">6</span><span class="err">的字符串</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="k">user</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">'yes___'</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="admonition-products-prod-name-prod-desc-toy-carrots admonition hint">
<p class="admonition-title">从 Products 表中检索产品名称（prod_name）和描述（prod_desc），仅返回在描述中以先后顺序同时出现 toy 和 carrots 的产品。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">prod_name</span><span class="p">,</span><span class="w"> </span><span class="n">prod_desc</span>
<span class="k">from</span><span class="w"> </span><span class="n">Products</span>
<span class="k">where</span><span class="w"> </span><span class="n">prod_desc</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">'%toy%carrots%'</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><dl>
<dt>正则表达  <code class="docutils literal notranslate"><span class="pre">regexp</span></code></dt><dd><ul>
<li><p>模糊匹配。如果不跟任何符号用也能模糊匹配，能返回包含关系的行</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="err">模糊匹配</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">where</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="n">regexp</span><span class="w"> </span><span class="s1">'yes'</span><span class="p">;</span>
<span class="c1">----------------------- # 只要有'yes'都能被匹配到</span>

<span class="k">select</span><span class="w"> </span><span class="n">prod_name</span><span class="p">,</span><span class="n">prod_desc</span>
<span class="k">from</span><span class="w"> </span><span class="n">Products</span>
<span class="k">where</span><span class="w"> </span><span class="n">prod_desc</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">REGEXP</span><span class="w"> </span><span class="s1">'toy'</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">prod_name</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</li>
</ol>
</section>
<section id="id6">
<h4 id="id6">复合条件的查询<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h4>
<div class="admonition-or-union-union-all admonition note">
<p class="admonition-title">复合条件的查询  <code class="docutils literal notranslate"><span class="pre">or,</span> <span class="pre">union,</span> <span class="pre">union</span> <span class="pre">all</span></code></p>
<ol class="arabic">
<li><dl>
<dt>是否去重</dt><dd><div class="line-block">
<div class="line">只要满足一个条件就被筛选出来，但总会存在一个人满足了多个条件， 但返回的结果是多少条呢？</div>
<div class="line">每条记录只返回一次就是 <strong>去重</strong>， 满足多少个条件就返回多少次是 <strong>不去重</strong></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>怎么看</dt><dd><p>先看完 condition1 再看 condition2， 有分界线的是 <strong>分别</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>先 match  <code class="docutils literal notranslate"><span class="pre">condition1</span></code>  然后又再 match  <code class="docutils literal notranslate"><span class="pre">condition2</span></code> 。每一条都先过完一遍  <code class="docutils literal notranslate"><span class="pre">condition1</span></code> ，再过一遍  <code class="docutils literal notranslate"><span class="pre">condition2</span></code></p></li>
</ul>
</div></blockquote>
<p>无所谓区分，condition1 和 condition2 混杂的是 <strong>按索引排序</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>每一条都过一遍排查 <code class="docutils literal notranslate"><span class="pre">condition1</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">condition2</span></code> 。</p></li>
<li><p>感觉这个会快一点，因为 match  <code class="docutils literal notranslate"><span class="pre">condition1</span></code>  就不用再 check  <code class="docutils literal notranslate"><span class="pre">condition2</span></code></p></li>
</ul>
</div></blockquote>
</dd>
</dl>
</li>
</ol>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>code</p></th>
<th class="head"><p>去重</p></th>
<th class="head"><p>分别</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">or</span></code></p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">union</span></code></p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">union</span> <span class="pre">all</span></code></p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
</tr>
</tbody>
</table>
<div class="admonition-device-idgenderagegpa admonition hint">
<p class="admonition-title">现在运营想要分别查看学校为山东大学或者性别为男性的用户的device_id、gender、age和gpa数据</p>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">or</span>
<span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="k">where</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'山东大学'</span><span class="w"> </span><span class="k">or</span>
<span class="w">    </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'male'</span><span class="p">;</span>
<span class="c1">------------------------------------ # 山东和男的交织，没有分界线，记录去重</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="k">union</span>
<span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="k">where</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'山东大学'</span>
<span class="k">union</span>
<span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="k">where</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'male'</span><span class="p">;</span>
<span class="c1">------------------------------------ # 先是山东再是男的，记录去重</span>

<span class="o">#</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="k">where</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'山东大学'</span>
<span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">gender</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="k">where</span><span class="w"> </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'male'</span><span class="p">;</span>
<span class="c1">------------------------------------ # 先是山东再是男的，记录不去重</span>
</pre></div>
</div>
</div>
<div class="admonition-and-or admonition note">
<p class="admonition-title">and &amp; or 的优先级</p>
<p>and 的优先级大于 or，所以可以考量括号加的情况</p>
</div>
<div class="admonition-order-by-union admonition danger">
<p class="admonition-title">多個  <code class="docutils literal notranslate"><span class="pre">order</span> <span class="pre">by</span></code>  和  <code class="docutils literal notranslate"><span class="pre">union</span></code>  一起用</p>
<p>order by不能直接出现在union的子句中，但是可以出现在子句的子句中。所以在外面再套一层 .</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="p">)</span>
<span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-uv-pv admonition hint">
<p class="admonition-title">请统计每个题目和每份试卷被作答的人数和次数，分别按照”试卷”和”题目”的uv &amp; pv降序显示</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">exam_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">uv</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pv</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tid</span>
<span class="w">    </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">uv</span><span class="o">+</span><span class="n">pv</span><span class="w"> </span><span class="k">desc</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">exam</span>
<span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="k">select</span><span class="w"> </span><span class="o">*</span>
<span class="k">from</span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">question_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">uv</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">pv</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">practice_record</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tid</span>
<span class="w">    </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">uv</span><span class="o">+</span><span class="n">pv</span><span class="w"> </span><span class="k">desc</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">question</span><span class="p">;</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>去重</p></li>
</ul>
<div class="admonition-distinct-union admonition note">
<p class="admonition-title">“谨慎使用 DISTINCT &amp; UNION”</p>
<p>查询调优的另一个好建议是仅在必要时使用DISTINCT和UNION运算符，因为与它们的查询会导致服务器开销，并通常会增加响应时间。考虑用UNION ALL取代UNION，用GROUP BY取代DISTINCT，以提高流程的效率</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span>
<span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span>
</pre></div>
</div>
</div>
</section>
<section id="with-group-by">
<h4 id="with-group-by">统计- 聚合函数 with  <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code><a class="headerlink" href="#with-group-by" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">cols</span> <span class="pre">from</span> <span class="pre">users</span> <span class="pre">group</span> <span class="pre">by</span> <span class="pre">col</span> <span class="pre">having</span> <span class="pre">condition</span></code></p>
<div class="admonition-null admonition danger">
<p class="admonition-title">聚合函数（列）都是对非null进行</p>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max(col)</span></code> ， <code class="docutils literal notranslate"><span class="pre">avg(col)</span></code> ，</p></li>
</ul>
<div class="admonition- admonition hint">
<p class="admonition-title">现在运营想要了解浙江大学的用户在不同难度题目下答题的正确率情况</p>
<ul class="simple">
<li><p>user_profile,device_id,university</p></li>
<li><p>question_practice_detail, device_id, question_id, result</p></li>
<li><p>question_detail, question_id,difficult_level</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">qd</span><span class="p">.</span><span class="n">difficult_level</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">qpd</span><span class="p">.</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'right'</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">end</span><span class="p">)</span><span class="o">/</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">correct_rate</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">device_id</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'浙江大学'</span>
<span class="p">)</span><span class="w"> </span><span class="n">up</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">question_practice_detail</span><span class="w"> </span><span class="n">qpd</span>
<span class="k">on</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qpd</span><span class="p">.</span><span class="n">device_id</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">question_detail</span><span class="w"> </span><span class="n">qd</span>
<span class="k">on</span><span class="w"> </span><span class="n">qpd</span><span class="p">.</span><span class="n">question_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qd</span><span class="p">.</span><span class="n">question_id</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">qd</span><span class="p">.</span><span class="n">difficult_level</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">correct_rate</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition- admonition hint">
<p class="admonition-title">运营想要了解每个学校 <strong>答过题</strong> 的用户平均答题数量情况。</p>
<div class="line-block">
<div class="line">user_profile， device_id指终端编号（认为每个用户有唯一的一个终端），university</div>
<div class="line">question_practice_detail，question_id是题目编号，result是答题结果</div>
<div class="line">存在学校没答过题的情况， 需要用 inner join 并且需要指明  <code class="docutils literal notranslate"><span class="pre">device_id</span></code>  ，因为 user_profile 里的 id 在 question_practice_detail 没出现过，就会 ambiguilous</div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">university</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">device_id</span><span class="p">)),</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_answer_cnt</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_profile</span><span class="w"> </span><span class="n">u</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">question_practice_detail</span><span class="w"> </span><span class="n">q</span>
<span class="k">on</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">device_id</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">university</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">university</span><span class="p">;</span>
</pre></div>
</div>
</div>
<ul>
<li><dl>
<dt>限制记录数量</dt><dd><p>计数同样从 0 开始</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">前</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="err">条</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">limit</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">一个连续的区间</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">+</span><span class="n">n</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">limit</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="c1">-----------</span>
<span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">users</span>
<span class="k">limit</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="k">offset</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>分组</dt><dd><p><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">cols</span> <span class="pre">from</span> <span class="pre">users</span> <span class="pre">group</span> <span class="pre">by</span> <span class="pre">col</span> <span class="pre">having</span> <span class="pre">condition;</span></code></p>
<div class="admonition-having-where admonition note">
<p class="admonition-title">“ <code class="docutils literal notranslate"><span class="pre">HAVING</span></code>  用于二次过滤; 在分组前先用  <code class="docutils literal notranslate"><span class="pre">WHERE</span></code>  过滤一些数据,分组的效率就会更高”</p>
</div>
<div class="admonition- admonition hint">
<p class="admonition-title">运营想要查看参加了答题的山东大学的用户在不同难度下的平均答题题目数，请取出相应数据</p>
<ul class="simple">
<li><p>user_profile, device_id, university</p></li>
<li><p>question_practice_detail, device_id, question_id</p></li>
<li><p>question_detail, question_id, difficult_level</p></li>
</ul>
<p>WHERE在前面先筛了山东大学，整个执行起来效率就会高很多</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">sdU</span><span class="p">.</span><span class="n">university</span><span class="p">,</span><span class="w"> </span><span class="n">qd</span><span class="p">.</span><span class="n">difficult_level</span><span class="p">,</span><span class="n">round</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="p">(</span><span class="n">qpd</span><span class="p">.</span><span class="n">device_id</span><span class="p">)),</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_answer_cnt</span>
<span class="k">from</span>
<span class="w">    </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="n">university</span><span class="p">,</span><span class="w"> </span><span class="n">device_id</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'山东大学'</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">sdU</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">question_practice_detail</span><span class="w"> </span><span class="n">qpd</span>
<span class="k">on</span><span class="w"> </span><span class="n">sdU</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qpd</span><span class="p">.</span><span class="n">device_id</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">question_detail</span><span class="w"> </span><span class="n">qd</span>
<span class="k">on</span><span class="w"> </span><span class="n">qpd</span><span class="p">.</span><span class="n">question_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qd</span><span class="p">.</span><span class="n">question_id</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">qd</span><span class="p">.</span><span class="n">difficult_level</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition-only-full-group-by admonition danger">
<p class="admonition-title">only_full_group_by</p>
<p>“Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column … which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by”</p>
<div class="line-block">
<div class="line">对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么这个SQL是不合法的，因为列不在GROUP BY从句中</div>
<div class="line"><strong>查出来的列必须在group by后面出现否则就会报错，或者这个字段出现在聚合函数里面。</strong></div>
<div class="line"><strong>Sol: 只需要在非group by的列上加any_value()</strong></div>
</div>
</div>
<div class="admonition-gpa-gpa2021month-q-cnt-avg-day-q-cnt admonition hint">
<p class="admonition-title">现在运营想要找到每个学校gpa最低的同学来做调研，请你取出每个学校的最低gpa。请从中统计出2021年每个月里用户的月总刷题数month_q_cnt 和日均刷题数avg_day_q_cnt（按月份升序排序）以及该年的总体情况</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">date_format</span><span class="p">(</span><span class="n">submit_time</span><span class="p">,</span><span class="s1">'%Y%m'</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">submit_month</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">month_q_cnt</span><span class="p">,</span>
<span class="w">    </span><span class="n">any_value</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="k">day</span><span class="p">(</span><span class="n">last_day</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)),</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_day_q_cnt</span>
<span class="k">from</span><span class="w"> </span><span class="n">practice_record</span>
<span class="k">where</span><span class="w"> </span><span class="k">year</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2021</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">submit_month</span>
<span class="k">union</span><span class="w"> </span><span class="k">all</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">all</span>
<span class="k">select</span><span class="w"> </span><span class="s1">'2021汇总'</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">submit_month</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">month_q_cnt</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_day_q_cnt</span>
<span class="k">from</span><span class="w"> </span><span class="n">practice_record</span>
<span class="k">where</span><span class="w"> </span><span class="k">year</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2021</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">submit_month</span><span class="p">;</span>
</pre></div>
</div>
</div>
</dd>
</dl>
</li>
<li><p>划分</p>
<blockquote>
<div><div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">cols</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span>
<span class="w">        </span><span class="k">case</span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">SCORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'A'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">'优'</span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">SCORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'B'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">'良'</span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">SCORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'C'</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">'中'</span>
<span class="w">            </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">'不及格'</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">new_col</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition- admonition hint">
<p class="admonition-title">现在运营想要将用户划分为25岁以下和25岁及以上两个年龄段，分别查看这两个年龄段用户数量.</p>
<p>本题注意：age为null 也记为 25岁以下</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="p">(</span><span class="k">case</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="n">age</span><span class="o">&gt;=</span><span class="mi">25</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="s1">'25岁及以上'</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="s1">'25岁以下'</span>
<span class="w">        </span><span class="k">end</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">age_cut</span><span class="p">,</span>
<span class="w">        </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">number</span>
<span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">age_cut</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div></blockquote>
</li>
<li><dl>
<dt>序列</dt><dd><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">cols</span> <span class="pre">from</span> <span class="pre">users</span> <span class="pre">order</span> <span class="pre">by</span> <span class="pre">col;</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">cols</span> <span class="pre">from</span> <span class="pre">users</span> <span class="pre">order</span> <span class="pre">by</span> <span class="pre">n;</span></code> 根據列索引</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">asc</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">desc</span></code></p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">quantity</span><span class="p">,</span><span class="w"> </span><span class="n">item_price</span>
<span class="k">from</span><span class="w"> </span><span class="n">OrderItems</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">desc</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</section>
<section id="id7">
<h4 id="id7">连表查询<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h4>
<div class="admonition- admonition note">
<p class="admonition-title">连接多张表</p>
<p>就一直写一直写就行</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">cols</span>
<span class="k">from</span><span class="w"> </span><span class="n">t1</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">t2</span>
<span class="k">on</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">col2</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">t3</span>
<span class="k">on</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t3</span><span class="p">.</span><span class="n">col</span>
<span class="p">...;</span>
</pre></div>
</div>
</div>
<div class="admonition-every-derived-table-must-have-its-own-alias admonition danger">
<p class="admonition-title">Every derived table must have its own alias</p>
<div class="line-block">
<div class="line">每个派生出来的表都必须有一个自己的别名。一般在多表查询时，会出现此错误。</div>
<div class="line">因为进行嵌套查询的时候子查询出来的的结果是作为一个 <strong>派生表</strong> 来进行上一级的查询的，所以子查询的结果必须要有一个别名</div>
<div class="line">把MySQL语句改成： <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">*</span> <span class="pre">from</span> <span class="pre">(select</span> <span class="pre">*</span> <span class="pre">from</span> <span class="pre">……)</span> <span class="pre">as</span> <span class="pre">别名;</span></code></div>
<div class="line">[mysql错误Every derived table must have its own alias解决]</div>
</div>
</div>
<div class="admonition- admonition note">
<p class="admonition-title">子查询和连表查询</p>
<div class="line-block">
<div class="line">子查询如果能大量减小信息熵，会比联表查快很多，数据多的时候联表会让表的大小成指数级增长，两者看具体情况选择。</div>
<div class="line">执行子查询时，MYSQL 需要创建临时表，查询完毕后再删除这些临时表，所以，子查询的速度会受到一定的影响，这里多了一个创建和销毁临时表的过程。</div>
<div class="line"><a class="reference external" href="https://blog.csdn.net/qiuchaoxi/article/details/81123920">https://blog.csdn.net/qiuchaoxi/article/details/81123920</a></div>
<div class="line"><a class="reference external" href="https://learnku.com/articles/43105">https://learnku.com/articles/43105</a></div>
</div>
</div>
<div class="admonition- admonition hint">
<p class="admonition-title">现在运营想要查看用户在某天刷题后第二天还会再来刷题的平均概率。</p>
<div class="line-block">
<div class="line">keys</div>
<div class="line">【去重】，同一个用户可能在某天刷了多次题，也可能在第二天刷了多次题。所以要同时  <code class="docutils literal notranslate"><span class="pre">distinct</span> <span class="pre">debice_id,</span> <span class="pre">date</span></code></div>
<div class="line">【先筛再连表】</div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">round</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">tmr</span><span class="p">.</span><span class="nb">date</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_ret</span>
<span class="k">from</span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">question_practice_detail</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">td</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">date_sub</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">day</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">date</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">question_practice_detail</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">tmr</span>
<span class="k">on</span><span class="w"> </span><span class="n">td</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmr</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">td</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmr</span><span class="p">.</span><span class="nb">date</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition- admonition hint">
<p class="admonition-title">现在运营想要了解复旦大学的每个用户在8月份练习的总题目数和回答正确的题目数情况，请取出相应明细数据，对于在8月份没有练习过的用户，答题数结果返回0.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">university</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">result</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">question_cnt</span><span class="p">,</span>
<span class="w">    </span><span class="k">sum</span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">qpd</span><span class="p">.</span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'right'</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">end</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">right_question_cnt</span>
<span class="k">from</span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'复旦大学'</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">up</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">question_practice_detail</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="k">month</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">08</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">qpd</span>
<span class="k">on</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">device_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qpd</span><span class="p">.</span><span class="n">device_id</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">device_id</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition- admonition hint">
<p class="admonition-title">请从表中统计出 “当月均完成试卷数”不小于3的用户们爱作答的类别及作答次数，按次数降序输出</p>
<div class="admonition- admonition danger">
<p class="admonition-title">注意題意</p>
<ol class="arabic simple">
<li><p>先看用戶</p></li>
<li><p>再統計愛作答的列別</p></li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tag_cnt</span>
<span class="k">from</span><span class="w"> </span><span class="n">examination_info</span><span class="w"> </span><span class="n">info</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">exam_record</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">exam_id</span><span class="p">)</span>
<span class="k">where</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">uid</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">uid</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">date_format</span><span class="p">(</span><span class="n">submit_time</span><span class="p">,</span><span class="w"> </span><span class="s1">'%Y%m'</span><span class="p">),</span><span class="w"> </span><span class="n">uid</span>
<span class="w">    </span><span class="k">having</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="p">)</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tag</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tag_cnt</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-sql-5uvavg-score admonition hint">
<p class="admonition-title">请计算每张SQL类别试卷发布后，当天5级以上的用户作答的人数uv和平均分avg_score，按人数降序，相同人数的按平均分升序</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">exam_id</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">user_info</span><span class="p">.</span><span class="n">uid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">uv</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">score</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_score</span>
<span class="k">from</span><span class="w"> </span><span class="n">exam_record</span><span class="w"> </span><span class="n">rec</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="n">release_time</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">examination_info</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQL'</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">exam_info</span>
<span class="k">on</span><span class="w"> </span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">submit_time</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">exam_info</span><span class="p">.</span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="p">(</span><span class="n">exam_info</span><span class="p">.</span><span class="n">release_time</span><span class="p">))</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">uid</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">user_info</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">user_info</span>
<span class="k">on</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_info</span><span class="p">.</span><span class="n">uid</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">exam_id</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">uv</span><span class="w"> </span><span class="k">desc</span><span class="p">,</span><span class="w"> </span><span class="n">avg_score</span><span class="w"> </span><span class="k">asc</span><span class="p">;</span>
</pre></div>
</div>
</div>
</section>
<section id="id8">
<h4 id="id8">拼接<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h4>
<table>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>連接多行</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">group_concat([distincrt]</span> <span class="pre">col</span> <span class="pre">[order</span> <span class="pre">by</span> <span class="pre">asc/desc</span> <span class="pre">col][separator</span> <span class="pre">','])</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>連接多列</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">concat(col1,</span> <span class="pre">',',</span> <span class="pre">col2,...)...;</span></code></p></td>
<td><p>有什麽連接什麽</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">concat_ws(',',</span> <span class="pre">col1,</span> <span class="pre">col2,</span> <span class="pre">...;)</span></code></p></td>
<td><p>指定分隔符</p></td>
</tr>
</tbody>
</table>
<div class="admonition-idtag admonition hint">
<p class="admonition-title">请统计2021年每个未完成试卷作答数大于1的有效用户的数据（有效用户指完成试卷作答数至少为1且未完成数小于5），输出用户ID、未完成试卷作答数、完成试卷作答数、作答过的试卷tag集合，按未完成试卷数量由多到少排序。</p>
<div class="admonition-distinct admonition danger">
<p class="admonition-title">如果沒有 distinct</p>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>實際</p></th>
<th class="head"><p>expected</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dd2021-07-02:SQL;2021-07-05:SQL;</p></td>
<td><p>2021-07-02:SQL 2021-07-05:SQL;</p></td>
</tr>
<tr class="row-odd"><td><p><strong>2021-09-01:算法;2021-09-01:算法;</strong></p></td>
<td><p><strong>2021-09-01:算法</strong>;2021-09-02:SQL;</p></td>
</tr>
<tr class="row-even"><td><p>2021-09-02:SQL;2021-09-05:SQL</p></td>
<td><p>2021-09-05:SQL</p></td>
</tr>
</tbody>
</table>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span>
<span class="w">    </span><span class="n">any_value</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">submit_time</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">end</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">incomplete_cnt</span><span class="p">,</span>
<span class="w">    </span><span class="n">any_value</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">submit_time</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">complete_cnt</span><span class="p">,</span>
<span class="w">    </span><span class="n">any_value</span><span class="p">(</span><span class="n">group_concat</span><span class="p">(</span><span class="w"> </span><span class="k">distinct</span>
<span class="w">        </span><span class="n">concat_ws</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">start_time</span><span class="p">),</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span>
<span class="w">        </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">start_time</span><span class="w"> </span><span class="n">separator</span><span class="w"> </span><span class="s1">';'</span>
<span class="w">    </span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">detail</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">submit_time</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="k">year</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2021</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rec</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">examination_info</span><span class="w"> </span><span class="n">info</span>
<span class="k">on</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">exam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">exam_id</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">uid</span>
<span class="k">having</span><span class="w"> </span><span class="n">incomplete_cnt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">complete_cnt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">incomplete_cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">incomplete_cnt</span><span class="w"> </span><span class="k">desc</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="id9">
<h3 id="id9">分组<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<div class="admonition- admonition hint">
<p class="admonition-title">在日常工作中，经常会遇到需要在每组内排名，比如下面的业务需求：</p>
<ul class="simple">
<li><p><strong>排名问题</strong>：每个部门按业绩来排名</p></li>
<li><p><strong>topN 问题</strong>：找出每个部门排名前N的员工进行奖励</p></li>
</ul>
<p>非全局排序，需要在某个维度下进行排序</p>
</div>
<section id="id10">
<h4 id="id10">窗口函数<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h4>
<p>窗口函数, OLAP, Online Anallytical Processing，联机分析处理，可以对数据库数据进行实时分析处理。</p>
<ul>
<li><p>同时具有分组和排序的功能</p></li>
<li><p>不减少原表的行数</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">&lt;窗口函数&gt;</span> <span class="pre">over</span> <span class="pre">(partition</span> <span class="pre">by</span> <span class="pre">&lt;用于分组的列名&gt;</span> <span class="pre">order</span> <span class="pre">by</span> <span class="pre">&lt;用于排序的列名&gt;)</span></code></p>
</div></blockquote>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">&lt;窗口函数&gt;</span></code></dt><dd><p>是对 <code class="docutils literal notranslate"><span class="pre">where</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code> 子句处理后的结果进行操作，所以窗口函数原则上只能写在 <code class="docutils literal notranslate"><span class="pre">select</span></code> 子句中</p>
<ul>
<li><dl>
<dt>专用窗口函数， <code class="docutils literal notranslate"><span class="pre">rank,</span> <span class="pre">dense_rank,</span> <span class="pre">row_number</span></code></dt><dd><table>
<thead>
<tr class="row-odd"><th class="head"><p>排序相同时</p></th>
<th class="head"><p>会重复</p></th>
<th class="head"><p>维持总数</p></th>
<th class="head"><p>排序结果</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rank()</span></code></p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>1、1、3</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">dense_rank()</span></code></p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>1、1、2</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">row_number()</span></code></p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
<td><p>1、2、3（根据primary key 来）</p></td>
</tr>
</tbody>
</table>
</dd>
</dl>
</li>
<li><p>聚合函数，如 <code class="docutils literal notranslate"><span class="pre">sum.</span> <span class="pre">avg,</span> <span class="pre">count,</span> <span class="pre">max,</span> <span class="pre">min</span></code> 等</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">partition</span> <span class="pre">by</span></code></dt><dd><p>可省略，省略就是不指定分组, 但是，这就失去了窗口函数的功能，所以一般不要这么使用</p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">【专用窗口函数】不要分组</span>
<span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">,</span>
<span class="w">    </span><span class="n">rank</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ranking</span><span class="p">,</span>
<span class="w">    </span><span class="n">dense_rank</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dese_rank</span><span class="p">,</span>
<span class="w">    </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">row_num</span>
<span class="k">from</span><span class="w"> </span><span class="n">scores</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">【专用窗口函数】要分组</span>
<span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="n">score</span><span class="p">,</span>
<span class="w">    </span><span class="n">rank</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ranking</span><span class="p">,</span>
<span class="w">    </span><span class="n">dense_rank</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">dese_rank</span><span class="p">,</span>
<span class="w">    </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">class</span><span class="w">  </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">desc</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">row_num</span>
<span class="k">from</span><span class="w"> </span><span class="n">scores</span><span class="p">;</span>

<span class="o">#</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="err">【聚合函数】要分组</span>
</pre></div>
</div>
<ul class="simple">
<li><p>[通俗易懂的学会：SQL窗口函数]</p></li>
</ul>
<section id="id11">
<h5 id="id11">常见业务<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h5>
<ul>
<li><dl>
<dt>最低最高</dt><dd><div class="admonition-gpa-gpa admonition hint">
<p class="admonition-title">现在运营想要找到每个学校gpa最低的同学来做调研，请你取出每个学校的最低gpa</p>
<p>先按 学校分组和对成绩排名，而不能用 <code class="docutils literal notranslate"><span class="pre">min</span></code></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">university</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span>
<span class="k">from</span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">device_id</span><span class="p">,</span><span class="w"> </span><span class="n">university</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span><span class="p">,</span>
<span class="w">        </span><span class="n">rank</span><span class="p">()</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">university</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">gpa</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rk</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">user_profile</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">olap</span>
<span class="k">where</span><span class="w"> </span><span class="n">olap</span><span class="p">.</span><span class="n">rk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>累积百分比</dt><dd><div class="admonition-xx-xx admonition hint">
<p class="admonition-title">想看前XX%的用户贡献了XX%的总额。</p>
</div>
</dd>
</dl>
</li>
<li><p>[hive sql]</p></li>
</ul>
</section>
</section>
</section>
</section>
<section id="operations">
<h2 id="operations">operations<a class="headerlink" href="#operations" title="Link to this heading">¶</a></h2>
<section id="insert">
<h3 id="insert">insert<a class="headerlink" href="#insert" title="Link to this heading">¶</a></h3>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>使用场景</p></th>
<th class="head"></th>
<th class="head"><p>语句</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>写上cols</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">insert</span> <span class="pre">into</span> <span class="pre">users(col1,</span> <span class="pre">col2,...)</span> <span class="pre">values</span> <span class="pre">(row1),</span> <span class="pre">(row2),..;</span></code></p></td>
<td><p>字段和value一一对应, null可以不写</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>导入数据</p></td>
<td><p>Ta-&gt; Tb</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">insert</span> <span class="pre">into</span> <span class="pre">Tb(b1,</span> <span class="pre">b2,</span> <span class="pre">...)</span> <span class="pre">select</span> <span class="pre">a1,</span> <span class="pre">a2,...</span> <span class="pre">from</span> <span class="pre">Ta</span> <span class="pre">where</span> <span class="pre">conditions;</span></code></p></td>
<td><p>名字可以不一样但是数据类型要一样</p></td>
</tr>
</tbody>
</table>
<div class="admonition-insert-into-tb-b1-b2-select-a1-a2-from-ta-where-conditions-values admonition danger">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">insert</span> <span class="pre">into</span> <span class="pre">Tb(b1,</span> <span class="pre">b2,</span> <span class="pre">...)</span> <span class="pre">select</span> <span class="pre">a1,</span> <span class="pre">a2,...</span> <span class="pre">from</span> <span class="pre">Ta</span> <span class="pre">where</span> <span class="pre">conditions;</span></code>  没有values</p>
<p>select读出来是多行多列，而values一个括号一次只能存入一行数据</p>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>primary key</dt><dd><ul>
<li><dl class="simple">
<dt>自增 id</dt><dd><ul>
<li><p>默认从 0 开始</p></li>
<li><p>插入时写  <code class="docutils literal notranslate"><span class="pre">0,</span> <span class="pre">null,</span> <span class="pre">default</span></code>  ，就会自动填充 id</p></li>
<li><p>写列名的时候可以跳，但是不写字段名的时候要写</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition- admonition danger">
<p class="admonition-title">插入重复问题</p>
<div class="line-block">
<div class="line">指的是 primary key</div>
<div class="line">Duplicate entry ‘1’ for key ‘PRIMARY’</div>
</div>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>sql</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">insert</span> <span class="pre">into</span> <span class="pre">users</span> <span class="pre">values</span> <span class="pre">...;</span></code></p></td>
<td><p>如果已经有了就报错</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">insert</span> <span class="pre">ignore</span> <span class="pre">into</span> <span class="pre">users</span> <span class="pre">values</span> <span class="pre">...;</span></code></p></td>
<td><p>如果有了就 ignore，继续</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">replace</span> <span class="pre">users</span> <span class="pre">values</span> <span class="pre">...;</span></code></p></td>
<td><p>无论如何都要插入，有了就 update</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">insert</span> <span class="pre">into</span> <span class="pre">users</span> <span class="pre">values</span> <span class="pre">...</span> <span class="pre">on</span> <span class="pre">duplicate</span> <span class="pre">key</span> <span class="pre">update</span> <span class="pre">col1</span> <span class="pre">=</span> <span class="pre">value1,</span> <span class="pre">col2</span> <span class="pre">=</span> <span class="pre">value2;</span></code></p></td>
<td><p>无论如何都要插入，有了就 update 指定的字段</p></td>
</tr>
</tbody>
</table>
<div class="admonition-exam-record-10012021911011129001-50-90-10022021947129002-10exam-record admonition hint">
<p class="admonition-title">牛客后台会记录每个用户的试卷作答记录到exam_record表，现在有两个用户的作答记录详情如下：用户1001在2021年9月1日晚上10点11分12秒开始作答试卷9001，并在50分钟后提交，得了90分；用户1002在2021年9月4日上午7点1分2秒开始作答试卷9002，并在10分钟后退出了平台。试卷作答记录表exam_record中，表已建好，其结构如下，请用一条语句将这两条记录插入表中。</p>
<p>没有提交就是null submit time</p>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">exam_record</span>
<span class="k">values</span>
<span class="w">    </span><span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="w"> </span><span class="mi">1001</span><span class="p">,</span><span class="w"> </span><span class="mi">9001</span><span class="p">,</span><span class="w"> </span><span class="s1">'2021-09-01 22:11:12'</span><span class="p">,</span><span class="w"> </span><span class="n">date_add</span><span class="p">(</span><span class="s1">'2021-09-01 22:11:12'</span><span class="p">,</span><span class="w"> </span><span class="nb">interval</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="k">minute</span><span class="p">),</span><span class="w"> </span><span class="mi">90</span><span class="p">),</span>
<span class="w">    </span><span class="p">(</span><span class="k">default</span><span class="p">,</span><span class="w"> </span><span class="mi">1002</span><span class="p">,</span><span class="w"> </span><span class="mi">9002</span><span class="p">,</span><span class="w"> </span><span class="s1">'2021-09-04 07:01:02'</span><span class="p">,</span><span class="w"> </span><span class="k">default</span><span class="p">,</span><span class="w"> </span><span class="k">default</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition-exam-record admonition hint">
<p class="admonition-title">现有一张试卷作答记录表exam_record，结构如下表，其中包含多年来的用户作答试卷记录，由于数据越来越多，维护难度越来越大，需要对数据表内容做精简，历史数据做备份。</p>
</div>
</section>
<section id="alter-update">
<h3 id="alter-update">alter &amp; update<a class="headerlink" href="#alter-update" title="Link to this heading">¶</a></h3>
<section id="alter-scheme">
<h4 id="alter-scheme"><code class="docutils literal notranslate"><span class="pre">alter</span></code>  基于表 scheme<a class="headerlink" href="#alter-scheme" title="Link to this heading">¶</a></h4>
<div class="admonition-alter-table-users admonition danger">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">alter</span> <span class="pre">table</span> <span class="pre">users</span></code>  每一句都要写</p>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>cases</p></th>
<th class="head"><p>基于表 scheme</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>添加列</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">alter</span> <span class="pre">table</span> <span class="pre">users</span> <span class="pre">add</span> <span class="pre">column</span> <span class="pre">col1</span> <span class="pre">int</span> <span class="pre">[first_after</span> <span class="pre">col5]</span></code></p></td>
<td><p>默认添加到最后一列</p></td>
</tr>
<tr class="row-odd"><td><p>修改列的类型或约束</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">alter</span> <span class="pre">table</span> <span class="pre">users</span> <span class="pre">modify</span> <span class="pre">column</span> <span class="pre">col1</span> <span class="pre">char</span> <span class="pre">constraint;</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>修改列名</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">alter</span> <span class="pre">table</span> <span class="pre">users</span> <span class="pre">change</span> <span class="pre">column</span> <span class="pre">old_col1</span> <span class="pre">new_col1</span> <span class="pre">char;</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>删除列</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">alter</span> <span class="pre">table</span> <span class="pre">users</span> <span class="pre">drop</span> <span class="pre">column</span> <span class="pre">col1;</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>修改表名</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">alter</span> <span class="pre">table</span> <span class="pre">old_users</span> <span class="pre">rename</span> <span class="pre">new_users;</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>将某一列放到第一列</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">alter</span> <span class="pre">table</span> <span class="pre">usrs</span> <span class="pre">modify</span> <span class="pre">column</span> <span class="pre">col1</span> <span class="pre">int</span> <span class="pre">first;</span></code></p></td>
<td></td>
</tr>
</tbody>
</table>
<div class="admonition-level15school-jobprofession-varchar10-achievement0 admonition hint">
<p class="admonition-title">请在用户信息表，字段level的后面增加一列最多可保存15个汉字的字段school；并将表中job列名改为profession，同时varchar字段长度变为10；achievement的默认值设置为0。</p>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">user_info</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">school</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="k">level</span><span class="p">;</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">user_info</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="n">profession</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">user_info</span><span class="w"> </span><span class="k">modify</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">achievement</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="update-records">
<h4 id="update-records"><code class="docutils literal notranslate"><span class="pre">update</span></code>   基于记录 records<a class="headerlink" href="#update-records" title="Link to this heading">¶</a></h4>
<div class="admonition-update admonition danger">
<p class="admonition-title">update</p>
<ul class="simple">
<li><p>更新的值要满足建表时的字段类型。比如score是int类型就不能更新为char类型。</p></li>
<li><p>更新的时候是按照代码语句的先后顺序更新的。</p></li>
</ul>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>when</p></th>
<th class="head"><p>基于记录 records</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>完全一个值</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">update</span> <span class="pre">users</span> <span class="pre">set</span> <span class="pre">col1</span> <span class="pre">=</span> <span class="pre">val1,</span> <span class="pre">col2</span> <span class="pre">=</span> <span class="pre">val2,...</span> <span class="pre">where</span> <span class="pre">condition;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>partial一个值</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">update</span> <span class="pre">users</span> <span class="pre">set</span> <span class="pre">col1</span> <span class="pre">=</span> <span class="pre">replace(col1,</span> <span class="pre">'old','new'),...;</span></code></p></td>
</tr>
<tr class="row-even"><td><p>多个值</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">update</span> <span class="pre">users</span> <span class="pre">set</span> <span class="pre">col1</span> <span class="pre">if(condition,val1,</span> <span class="pre">val2);</span></code> <code class="docutils literal notranslate"><span class="pre">case</span></code>  也可以</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="delete-truncate">
<h3 id="delete-truncate">delete &amp; truncate<a class="headerlink" href="#delete-truncate" title="Link to this heading">¶</a></h3>
<div class="admonition-truncate-drop admonition danger">
<p class="admonition-title">“非必要不要用 truncate 或 drop”</p>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>case</p></th>
<th class="head"><p>sql</p></th>
<th class="head"></th>
<th class="head"><p>自增值重置</p></th>
<th class="head"><p>rollback</p></th>
<th class="head"><p>速度</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>删除记录</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">delete</span> <span class="pre">from</span> <span class="pre">users</span> <span class="pre">where</span> <span class="pre">condition;</span></code></p></td>
<td><p>DML，可加where</p></td>
<td><p>❌</p></td>
<td><p>✅</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>清空截断表</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">truncate</span> <span class="pre">users;</span></code></p></td>
<td><p>DDL，drop 之后再 create 新的，有drop的权限</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>销毁表、视图</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">drop</span> <span class="pre">users;</span></code></p></td>
<td><p>DDL，</p></td>
<td><p>都没了</p></td>
<td><p>❌</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<div class="admonition-exam-record-5-3-exam-record-start-time-submit-time admonition hint">
<p class="admonition-title">请删除 exam_record 表中未完成作答或作答时间小于5分钟整的记录中，开始作答时间最早的3条记录。作答记录表 exam_record, start_time 是试卷开始时间。submit_time 是交卷时间，即结束时间，如果未完成的话，则为空。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">delete</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="k">where</span><span class="w"> </span><span class="n">submit_time</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">or</span>
<span class="w">    </span><span class="n">timestampdiff</span><span class="p">(</span><span class="k">minute</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">submit_time</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">start_time</span>
<span class="k">limit</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</pre></div>
</div>
</div>
</section>
<section id="create">
<h3 id="create">create<a class="headerlink" href="#create" title="Link to this heading">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">[</span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="p">]</span><span class="w"> </span><span class="n">users</span>
<span class="p">(</span>
<span class="w">    </span><span class="n">col1</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span>
<span class="w">                </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span>
<span class="w">                </span><span class="n">auto_increment</span><span class="w">  </span><span class="o">#</span><span class="err">自增</span>
<span class="w">                </span><span class="k">comment</span><span class="w"> </span><span class="p">...</span><span class="w">  </span><span class="o">#</span><span class="err">注释</span>
<span class="w">                </span><span class="k">default</span><span class="w"> </span><span class="n">default_val</span><span class="o">/</span><span class="w"> </span><span class="k">current_timestamp</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">当前时间戳</span>
<span class="w">                </span><span class="k">unique</span>
<span class="w">                </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="err">不允许空</span>
<span class="w">                </span><span class="p">],</span>
<span class="w">    </span><span class="n">col2</span><span class="w">  </span><span class="nb">char</span><span class="w">  </span><span class="p">...</span><span class="w"> </span><span class="p">,</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">)[</span><span class="k">default</span><span class="w"> </span><span class="n">charset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="k">collate</span><span class="w"> </span><span class="err">编码</span><span class="p">];</span>
</pre></div>
</div>
<ul class="simple">
<li><p>[collate 编码](#unicode)</p></li>
</ul>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>charset</p></th>
<th class="head"><p>default collayte</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">utf8</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">utf8_general_ci</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">utf8mb4</span></code> 👍</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">utf8mb4_unicode_ci</span></code></p></td>
</tr>
</tbody>
</table>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">user_info_vip</span>
<span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">auto_increment</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">'自增ID'</span><span class="p">,</span>
<span class="w">    </span><span class="n">uid</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">unique</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">'用户ID'</span><span class="p">,</span>
<span class="w">    </span><span class="n">nick_name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">'昵称'</span><span class="p">,</span>
<span class="w">    </span><span class="n">achievement</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">'成就值'</span><span class="p">,</span>
<span class="w">    </span><span class="k">level</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">'用户等级'</span><span class="p">,</span>
<span class="w">    </span><span class="n">job</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">'职业方向'</span><span class="p">,</span>
<span class="w">    </span><span class="n">register_time</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="k">current_timestamp</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">'注册时间'</span>
<span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</pre></div>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>case</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>存在就覆盖</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">drop</span> <span class="pre">table</span> <span class="pre">if</span> <span class="pre">exist</span> <span class="pre">users</span> <span class="pre">(...);</span></code>  &amp;  <code class="docutils literal notranslate"><span class="pre">create</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>存在就返回</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">create</span> <span class="pre">table</span> <span class="pre">if</span> <span class="pre">not</span> <span class="pre">exists</span> <span class="pre">(...);</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="index">
<h3 id="index">index<a class="headerlink" href="#index" title="Link to this heading">¶</a></h3>
<div class="admonition- admonition danger">
<p class="admonition-title">“没有内置修改索引操作的，需要先执行删除操作在重新建立一个索引”</p>
</div>
<div class="admonition-create-fulltime-index admonition danger">
<p class="admonition-title">“先导数据再设  <code class="docutils literal notranslate"><span class="pre">create</span> <span class="pre">fulltime</span> <span class="pre">index</span></code> “</p>
<p>在数据量较大时候，先将数据放入一个没有全文索引的表中，然后再用CREATE INDEX创建FULLTEXT索引，要比先为一张表建立FULLTEXT然后再将数据写入的速度快很多。</p>
</div>
<section id="create2">
<h4 id="create2">create2<a class="headerlink" href="#create2" title="Link to this heading">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">#</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="err">创建表时</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">users</span><span class="p">(</span>
<span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span>
<span class="k">index</span><span class="w"> </span><span class="n">index_name</span><span class="w"> </span><span class="p">[</span><span class="n">description</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">col</span><span class="p">);</span>
<span class="p">);</span>

<span class="o">#</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="err">另外创建</span>
<span class="k">create</span><span class="w"> </span><span class="p">[</span><span class="n">description</span><span class="p">]</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">index_name</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">users</span><span class="p">(</span><span class="n">col</span><span class="p">);</span>

<span class="o">#</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="err">修改表时</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">users</span>
<span class="k">add</span><span class="w"> </span><span class="p">[</span><span class="n">description</span><span class="p">]</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">index_name</span><span class="p">(</span><span class="n">col</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition-unique-index-primary-key admonition note">
<p class="admonition-title">“ <code class="docutils literal notranslate"><span class="pre">unique</span> <span class="pre">index</span></code>  &amp;  <code class="docutils literal notranslate"><span class="pre">primary</span> <span class="pre">key</span></code> “</p>
<div class="line-block">
<div class="line">都是唯一的值，不可以出现相同的值</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">unqiue</span> <span class="pre">index</span></code>  可以一个表多个</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">primary</span> <span class="pre">key</span></code>  只能一表一个</div>
</div>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>cases</p></th>
<th class="head"><p>[description]</p></th>
<th class="head"></th>
<th class="head"><p>NULL</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>唯一</p></td>
<td><p>unique</p></td>
<td><p>不可以出现相同的值</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-odd"><td><p>全文</p></td>
<td><p>fulltxt</p></td>
<td><p>针对值中的某个单词，但效率低（不建议，可利用添加关键词关联列来实现）,按照分词原理建立索引的</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>普通</p></td>
<td></td>
<td><p>允许出现相同的索引内容</p></td>
<td></td>
</tr>
</tbody>
</table>
<p>普通索引：INDEX  (normal)</p>
<p>[mysql 不同索引的区别和适用情况总结]</p>
<div class="admonition-examination-info-examination-info admonition hint">
<p class="admonition-title">现有一张试卷信息表examination_info，其中包含各种类型试卷的信息。为了对表更方便快捷地查询，需要在examination_info表创建以下索引，规则如下：</p>
<p>在duration列创建普通索引idx_duration、在exam_id列创建唯一性索引uniq_idx_exam_id、在tag列创建全文索引full_idx_tag</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">idx_duration</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">examination_info</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>
<span class="k">create</span><span class="w"> </span><span class="k">unique</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">uniq_idx_exam_id</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">examination_info</span><span class="p">(</span><span class="n">exam_id</span><span class="p">);</span>
<span class="k">create</span><span class="w"> </span><span class="n">fulltext</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">full_idx_tag</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">examination_info</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
</pre></div>
</div>
</div>
</section>
<section id="delete">
<h4 id="delete">delete<a class="headerlink" href="#delete" title="Link to this heading">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">index_name</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">users</span><span class="p">;</span>

<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">users</span>
<span class="k">drop</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">index_name</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id12">
<h2 id="id12">业务<a class="headerlink" href="#id12" title="Link to this heading">¶</a></h2>
<div class="admonition-sqlexam-recordsql admonition hint">
<p class="admonition-title">牛客的运营同学想要查看大家在SQL类别中高难度试卷的得分情况。请你帮她从exam_record数据表中计算所有用户完成SQL类别高难度试卷得分的截断平均值（去掉一个最大值和一个最小值后的平均值）。</p>
<p><span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><mo>∑</mo><mo>−</mo><mi>max</mi><mo>⁡</mo><mo>−</mo><mi>min</mi><mo>⁡</mo></mrow><mrow><mi mathvariant="normal">#</mi><mo>−</mo><mn>2</mn></mrow></mfrac></mstyle></mrow><annotation encoding="application/x-tex">=\cfrac{\sum-\max-\min}{\#-2}</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4704em;vertical-align:-0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">#</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">max</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span></span></span></span></span></span></span></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">difficulty</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">((</span><span class="k">sum</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">-</span><span class="k">min</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">-</span><span class="k">max</span><span class="p">(</span><span class="n">score</span><span class="p">))</span><span class="o">/</span>
<span class="w">        </span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_score</span>
<span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">difficulty</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">examination_info</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">tag</span><span class="o">=</span><span class="s1">'SQL'</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">difficulty</span><span class="o">=</span><span class="s1">'hard'</span>
<span class="w">    </span><span class="p">)</span><span class="n">info</span>
<span class="k">on</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">exam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exam_record</span><span class="p">.</span><span class="n">exam_id</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="admonition-exam-record-total-pvcomplete-pvcomplete-exam-cnt admonition hint">
<p class="admonition-title">有一个试卷作答记录表exam_record，请从中统计出总作答次数total_pv、试卷已完成作答数complete_pv、已完成的试卷数complete_exam_cnt。</p>
<p>示例数据 exam_record表（uid用户ID, exam_id试卷ID, start_time开始作答时间, submit_time交卷时间, score得分）</p>
<p>主要在于已完成的试卷数的统计，因为这个带有条件，且需要统计聚合结果，很自然可以想到 使用 聚合函数与case when 结合。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">total_pv</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">complete_pv</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">exam_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">end</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">complete_exam_cnt</span>
<span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
</pre></div>
</div>
</div>
<div class="admonition-sql admonition hint">
<p class="admonition-title">请从试卷作答记录表中找到SQL试卷得分不小于该类试卷平均得分的用户最低得分。</p>
<p>示例数据 exam_record表（uid用户ID, exam_id试卷ID, start_time开始作答时间, submit_time交卷时间, score得分）：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">min_score_over_avg</span>
<span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">exam_id</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">examination_info</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQL'</span>
<span class="w">    </span><span class="p">)</span><span class="n">info</span>
<span class="k">on</span><span class="w"> </span><span class="n">exam_record</span><span class="p">.</span><span class="n">exam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">exam_id</span>
<span class="k">where</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="n">exam_id</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">examination_info</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQL'</span>
<span class="w">        </span><span class="p">)</span><span class="n">info</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">exam_record</span><span class="p">.</span><span class="n">exam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">exam_id</span>
<span class="w">    </span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition-avg-active-daysmau admonition hint">
<p class="admonition-title">请计算2021年每个月里试卷作答区用户平均月活跃天数avg_active_days和月度活跃人数mau，上面数据的示例输出如下：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">submit_time</span><span class="p">,</span><span class="w"> </span><span class="ss">"%Y%m"</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">month</span><span class="p">,</span>
<span class="w">    </span><span class="n">round</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">DATE_FORMAT</span><span class="p">(</span><span class="n">submit_time</span><span class="p">,</span><span class="w"> </span><span class="ss">"%Y%m%d"</span><span class="p">))</span><span class="o">/</span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">uid</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">avg_active_days</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">uid</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mau</span>
<span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="k">where</span><span class="w"> </span><span class="k">year</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2021</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">month</span>
</pre></div>
</div>
</div>
<div class="admonition-sql807-2021-2021 admonition hint">
<p class="admonition-title">请你找到高难度SQL试卷得分平均值大于80并且是7级的红名大佬，统计他们的2021年试卷总完成次数和题目总练习次数，只保留2021年有试卷完成记录的用户。结果按试卷完成数升序，按题目练习数降序。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span><span class="w"> </span><span class="n">red_users</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="n">exam_submit</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">exam_cnt</span><span class="p">,</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="k">distinct</span><span class="w"> </span><span class="n">question_id</span><span class="p">,</span><span class="w"> </span><span class="n">prac_submit</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">question_cnt</span>
<span class="k">from</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">uid</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">exam_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">exam_id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">examination_info</span>
<span class="w">                        </span><span class="k">where</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SQL'</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">difficulty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'hard'</span><span class="p">)</span>
<span class="w">            </span><span class="k">and</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">user_info</span>
<span class="w">                        </span><span class="k">where</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">uid</span>
<span class="w">    </span><span class="k">having</span><span class="w"> </span><span class="k">avg</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">80</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">red_users</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="n">submit_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">exam_submit</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">exam_record</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="k">year</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)</span><span class="o">=</span><span class="mi">2021</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">exam_rec</span>
<span class="k">on</span><span class="w"> </span><span class="n">red_users</span><span class="p">.</span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exam_rec</span><span class="p">.</span><span class="n">uid</span>
<span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">question_id</span><span class="p">,</span><span class="w"> </span><span class="n">submit_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">prac_submit</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">practice_record</span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="k">year</span><span class="p">(</span><span class="n">submit_time</span><span class="p">)</span><span class="o">=</span><span class="mi">2021</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="n">prac_rec</span>
<span class="k">on</span><span class="w"> </span><span class="n">red_users</span><span class="p">.</span><span class="n">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prac_rec</span><span class="p">.</span><span class="n">uid</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">uid</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">exam_cnt</span><span class="w"> </span><span class="k">asc</span><span class="p">,</span><span class="w"> </span><span class="n">question_cnt</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>[SELECT 1 FROM TABLE的作用]: <a class="reference external" href="https://blog.51cto.com/knifeedge/5786611">https://blog.51cto.com/knifeedge/5786611</a>
[select 1 in SQL]: <a class="reference external" href="https://www.jianshu.com/p/0c5dbee8838b">https://www.jianshu.com/p/0c5dbee8838b</a>
[int(1)和int(11)的区别]: <a class="reference external" href="https://www.modb.pro/db/336129">https://www.modb.pro/db/336129</a>
[日期函数]: <a class="reference external" href="https://www.nowcoder.com/knowledge/intro-index?kcid=20">https://www.nowcoder.com/knowledge/intro-index?kcid=20</a>
[MySQL常用函数——字符函数]: <a class="reference external" href="https://ost.51cto.com/posts/12630">https://ost.51cto.com/posts/12630</a>
[mysql错误Every derived table must have its own alias解决]: <a class="reference external" href="https://www.jianshu.com/p/c52180dd259a">https://www.jianshu.com/p/c52180dd259a</a>
[hive sql]: <a class="reference external" href="https://zhuanlan.zhihu.com/p/114921777">https://zhuanlan.zhihu.com/p/114921777</a>
[通俗易懂的学会：SQL窗口函数]: <a class="reference external" href="https://www.zhihu.com/tardis/zm/art/92654574?source_id=1003">https://www.zhihu.com/tardis/zm/art/92654574?source_id=1003</a>
[MySQL 編碼挑選與差異比較]: <a class="reference external" href="https://khiav223577.github.io/blog/2019/06/30/MySQL-%E7%B7%A8%E7%A2%BC%E6%8C%91%E9%81%B8%E8%88%87%E5%B7%AE%E7%95%B0%E6%AF%94%E8%BC%83/">https://khiav223577.github.io/blog/2019/06/30/MySQL-%E7%B7%A8%E7%A2%BC%E6%8C%91%E9%81%B8%E8%88%87%E5%B7%AE%E7%95%B0%E6%AF%94%E8%BC%83/</a>
[mysql 不同索引的区别和适用情况总结]: <a class="reference external" href="https://www.cnblogs.com/DDgougou/p/10286709.html">https://www.cnblogs.com/DDgougou/p/10286709.html</a></p>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="index.html" title="SQL"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> "Previous" </span> SQL </span>
              </div>
            </a>
          
          
            <a href="../utils/index.html" title="杂"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> "Next" </span> 杂 </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2024, coconut.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>